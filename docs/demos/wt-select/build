#!/usr/bin/env python3
"""Build script for wt select demo GIF.

Uses the shared prepare_demo_repo() infrastructure with alpha/beta/hooks branches,
same as wt-core and wt-merge demos.

See CLAUDE.md for full setup details.
"""

import os
import shutil
import sys
from pathlib import Path

# Add docs/demos/ to path for shared library
SCRIPT_DIR = Path(__file__).parent
DEMOS_DIR = SCRIPT_DIR.parent
sys.path.insert(0, str(DEMOS_DIR))

from shared import (
    DemoEnv,
    prepare_demo_repo,
    check_dependencies, setup_demo_output, record_all_themes,
)

REPO_ROOT = DEMOS_DIR.parent.parent
OUT_DIR = SCRIPT_DIR / "out"
TAPE_TEMPLATE = SCRIPT_DIR / "demo.tape"

OUTPUT_GIFS = {
    "light": OUT_DIR / "wt-select.gif",
    "dark": OUT_DIR / "wt-select-dark.gif",
}

# Custom VHS binary with keystroke overlay
VHS_BINARY = os.environ.get("VHS_KEYSTROKES", str(SCRIPT_DIR / "vhs-keystrokes" / "vhs-keystrokes"))


def main():
    check_dependencies(["git"])
    setup_demo_output(OUT_DIR)

    # Create demo environment (uses shared infrastructure like other demos)
    demo_env = DemoEnv(name="select", out_dir=OUT_DIR, repo_name="acme")
    prepare_demo_repo(demo_env, REPO_ROOT)

    print(f"\nDemo repo created at: {demo_env.repo}")
    print(f"Worktrees at: {demo_env.work_base}")

    # Record if VHS is available
    vhs_available = Path(VHS_BINARY).exists() if "/" in VHS_BINARY else shutil.which(VHS_BINARY)
    if vhs_available:
        record_all_themes(demo_env, TAPE_TEMPLATE, OUTPUT_GIFS, REPO_ROOT, vhs_binary=VHS_BINARY)
    else:
        print(f"\nSkipping GIF recording ({VHS_BINARY} not available)")
        print("\nTo test manually:")
        print(f"  cd {demo_env.repo}")
        print(f"  HOME={demo_env.home} wt select")


if __name__ == "__main__":
    main()
